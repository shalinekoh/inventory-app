<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title %></title>
  </head>
  <body>
    <%- include("header") %>
    <h1><%= title %></h1>
    <%- include("forms/create-category", {parentId : parentId}) %> <%
    if(parentId) { %> <%- include("forms/create-item", {parentId : parentId}) %>
    <% } %>

    <ul>
      <!-- Display subcategories -->
      <% if (categories.length > 0) { %> <% categories.forEach((category) => {
      %>
      <li>
        <a href="/category/<%= category.id %>"><%= category.name %></a>

        <!-- Add a class for edit buttons and dialogs to make them reusable -->
        <button
          type="button"
          class="editBtn"
          data-category-id="<%= category.id %>"
          data-current-name="<%= category.name %>"
        >
          Edit
        </button>

        <!-- Dialog for each category -->
        <dialog class="catDialog">
          <h1>Rename category</h1>
          <form method="POST" action="/category/<%= category.id %>/update">
            <input
              type="text"
              name="categoryName"
              placeholder="Enter the name here"
              required
            />
            <button type="button" class="cancelBtn">Cancel</button>
            <button type="submit">Enter</button>
          </form>
        </dialog>

        <!-- Delete form -->
        <form method="POST" action="/category/<%=category.id %>/delete">
          <button type="submit">Delete</button>
        </form>
      </li>
      <% }) %> <% } %>
    </ul>

    <ul>
      <!-- Display items -->
      <% if (items.length > 0) { %> <% items.forEach((item) => { %>
      <li><%= item.name %></li>
      <button
        type="button"
        class="itemEditBtn"
        data-item-id="<%= item.id%>"
        data-item-name="<%= item.name %>"
        data-item-quantity="<%=item.quantity %>"
      >
        Edit
      </button>
      <dialog id="dialog-<%=item.id%>">
        <form method="POST" action="/item/<%=item.id%>/update">
          <input
            type="text"
            name="itemName"
            placeholder="Rename item"
            required
          />
          <input type="number" name="itemQuantity" min="1" required />
          <button type="button" id="cancel-<%=item.id%>">Cancel</button>
          <button type="submit">Enter</button>
        </form>
      </dialog>
      <form method="POST" action="/item/<%=item.id%>/delete">
        <button type="submit">Delete</button>
      </form>
      <% }) %> <% } %>
    </ul>

    <script>
      // Select all edit buttons and dialogs
      const editButtons = document.querySelectorAll(".editBtn");
      const cancelButtons = document.querySelectorAll(".cancelBtn");

      editButtons.forEach((editButton) => {
        const categoryId = editButton.getAttribute("data-category-id");
        const currentName = editButton.getAttribute("data-current-name");
        const dialog = editButton.nextElementSibling; // The dialog is right after the button

        editButton.addEventListener("click", () => {
          const nameInput = dialog.querySelector('input[name="categoryName"]');
          nameInput.value = currentName; // Pre-fill with the current category name
          dialog.showModal(); // Show the dialog
        });
      });

      // Add event listeners to cancel buttons to close dialogs
      cancelButtons.forEach((cancelButton) => {
        cancelButton.addEventListener("click", (e) => {
          const dialog = cancelButton.closest("dialog");
          dialog.close(); // Close the dialog
        });
      });

      const itemEditButtons = document.querySelectorAll(".itemEditBtn");
      itemEditButtons.forEach((editBtn) => {
        const itemId = editBtn.getAttribute("data-item-id");
        const currentName = editBtn.getAttribute("data-item-name");
        const currentQuantity = editBtn.getAttribute("data-item-quantity");
        const dialog = document.getElementById(`dialog-${itemId}`);
        const cancelBtn = document.getElementById(`cancel-${itemId}`);

        editBtn.addEventListener("click", () => {
          const nameInput = dialog.querySelector('input[name="itemName"]');
          nameInput.value = currentName;
          const quantityInput = dialog.querySelector(
            'input[name="itemQuantity"]'
          );
          quantityInput.value = currentQuantity;
          dialog.showModal();
        });

        cancelBtn.addEventListener("click", () => {
          dialog.close();
        });
      });
    </script>
  </body>
</html>
